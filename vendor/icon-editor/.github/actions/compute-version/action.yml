name: "Compute Version"
description: "Determines semantic version components and full version string based on branch, labels and commit count."
inputs:
  github_token:
    description: "GitHub token with repository access"
    required: true
outputs:
  VERSION:
    description: "Full version string"
    value: ${{ steps.next_version.outputs.VERSION }}
  MAJOR:
    description: "Major version"
    value: ${{ steps.next_version.outputs.MAJOR }}
  MINOR:
    description: "Minor version"
    value: ${{ steps.next_version.outputs.MINOR }}
  PATCH:
    description: "Patch version"
    value: ${{ steps.next_version.outputs.PATCH }}
  BUILD:
    description: "Commit-based build number"
    value: ${{ steps.inc_build.outputs.new_build_number }}
  IS_PRERELEASE:
    description: "Whether the version is a prerelease"
    value: ${{ steps.next_version.outputs.IS_PRERELEASE }}
runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Determine bump type
      id: bump_type
      uses: actions/github-script@v6
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const allowed = ['major', 'minor', 'patch'];
          let bump = 'none';
          if (context.event_name === 'pull_request') {
            const labels = context.payload.pull_request.labels.map(l => l.name.toLowerCase());
            const found = labels.filter(l => allowed.includes(l));
            if (found.length > 1) {
              core.setFailed(`Conflicting release labels detected: ${found.join(', ')}`);
              return;
            }
            bump = found[0] || 'patch';
          }
          core.setOutput('bump_type', bump);

    - name: Determine build number
      id: inc_build
      shell: pwsh
      run: |
        git fetch --unshallow 2>$null || Write-Host "Already a full clone."
        $count = git rev-list --count HEAD
        Write-Host "Commit-based build number => $count"
        "new_build_number=$count" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

    - name: Compute version string
      id: next_version
      shell: pwsh
      env:
        BUMP_TYPE:    ${{ steps.bump_type.outputs.bump_type }}
        BUILD_NUMBER: ${{ steps.inc_build.outputs.new_build_number }}
      run: |
        $latest = (git describe --tags --abbrev=0 2>$null).TrimStart('v') -replace '-build.*'
        if (-not $latest) { $maj=0; $min=0; $pat=0 } else { $maj,$min,$pat = $latest.Split('.') }
        switch ($env:BUMP_TYPE) {
          'major' { $maj++; $min=0; $pat=0 }
          'minor' { $min++; $pat=0 }
          'patch' { $pat++ }
        }
        $branch = $Env:GITHUB_REF -replace '^refs/heads/',''
        $suffix = ''
        if ($branch -like 'release-alpha/*') { $suffix = "alpha.$($Env:BUILD_NUMBER)" }
        elseif ($branch -like 'release-beta/*')  { $suffix = "beta.$($Env:BUILD_NUMBER)" }
        elseif ($branch -like 'release-rc/*')    { $suffix = "rc.$($Env:BUILD_NUMBER)" }
        $version = if ($suffix) { "v$maj.$min.$pat-$suffix-build$($Env:BUILD_NUMBER)" } else { "v$maj.$min.$pat-build$($Env:BUILD_NUMBER)" }
        $isPre  = if ($suffix) { 'true' } else { 'false' }
        Write-Host "Computed version => $version"
        "VERSION=$version"      | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
        "MAJOR=$maj"            | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
        "MINOR=$min"            | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
        "PATCH=$pat"            | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
        "IS_PRERELEASE=$isPre"  | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
