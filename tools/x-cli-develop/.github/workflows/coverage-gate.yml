name: PR Coverage Gate
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  coverage:
    name: coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: .NET tests with coverage (Cobertura)
        run: |
          dotnet test XCli.sln -c Release --collect:"XPlat Code Coverage" -- \
            DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Python tests with coverage (Cobertura XML)
        run: |
          python -m pip install --upgrade pip
          pip install pytest coverage pytest-cov
          mkdir -p artifacts/python-coverage
          pytest -q tests --cov=scripts --cov=tests/__ci__ --cov-report=xml:artifacts/python-coverage/coverage.xml || true

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Merge coverage reports
        run: |
          reportgenerator -reports:"**/coverage.cobertura.xml;artifacts/python-coverage/coverage.xml" \
            -targetdir:artifacts/coverage -reporttypes:Cobertura,HtmlInline_AzurePipelines
          cp artifacts/coverage/Cobertura.xml coverage.xml

      - name: Upload coverage pack
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-pack
          path: |
            artifacts/coverage
            coverage.xml
