name: Action CI (post-comment-or-artifact)

on:
  push:
    paths:
      - '.github/actions/post-comment-or-artifact/**'
      - 'scripts/ghops/tools/post-comment-or-artifact.ps1'
      - 'scripts/ghops/tools/post-comment-or-artifact.sh'
      - '.github/workflows/post-comment-or-artifact-ci.yml'
  pull_request:
    paths:
      - '.github/actions/post-comment-or-artifact/**'
      - 'scripts/ghops/tools/post-comment-or-artifact.ps1'
      - 'scripts/ghops/tools/post-comment-or-artifact.sh'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Prepare comment (bash)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p telemetry
          printf "# X-CLI CI Summary\n\n\`\`\`text\nhello from linux\n\`\`\`\n" > telemetry/comment.md

      - name: Prepare comment (pwsh)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path telemetry | Out-Null
          @(
            '# X-CLI CI Summary','',
            '```text','hello from windows','```'
          ) -join "`n" | Out-File -Encoding utf8NoBOM -FilePath telemetry/comment.md

      - name: Simulate post (dry-run)
        id: post
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('posted','false');
            core.setOutput('reason','dry-run')

      - name: Check outputs
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "posted=${{ steps.post.outputs.posted }} reason=${{ steps.post.outputs.reason }}"
          test "${{ steps.post.outputs.posted }}" = "false"
