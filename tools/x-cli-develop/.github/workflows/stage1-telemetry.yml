# SRS: FGC-REQ-DEV-004 name: Stage 1 Telemetry  on:   workflow_dispatch:     inputs:       debug_token_info:         description: "Upload effective token info artifact (debug)"         required: false         default: false         type: boolean       validate_schema:         description: "Validate telemetry summary/events against JSON Schema"         required: false         default: false         type: boolean       source_repository:         description: "Repository to checkout for telemetry generation"         required: false       source_ref:         description: "Ref to checkout in source repository"         required: false   workflow_call:     inputs:       debug_token_info:         required: false         type: boolean       validate_schema:         required: false         type: boolean       source_repository:         required: false         type: string       source_ref:         required: false         type: string     outputs:       run_id:         description: "GitHub Actions run id for Stage 1"         value: ${{ jobs.telemetry.outputs.run_id }}       summary_path:         description: "Path to telemetry/summary.json produced by Stage 1"         value: ${{ jobs.telemetry.outputs.summary_path }}  jobs:   telemetry:     runs-on: ubuntu-latest     env:       DEBUG_TOKEN_INFO: ${{ inputs.debug_token_info || github.event.inputs.debug_token_info || vars.DEBUG_TOKEN_INFO }}       VALIDATE_TELEMETRY_SCHEMA: ${{ inputs.validate_schema || github.event.inputs.validate_schema || vars.VALIDATE_TELEMETRY_SCHEMA }}       SOURCE_REPOSITORY: ${{ inputs.source_repository || github.event.inputs.source_repository || github.repository }}       SOURCE_REF: ${{ inputs.source_ref || github.event.inputs.source_ref || github.ref }}     outputs:       run_id: ${{ steps.emit.outputs.run_id }}       summary_path: ${{ steps.emit.outputs.summary_path }}     steps:       - name: Normalize source repo/ref         id: normalize         shell: bash         run: |           set -euo pipefail           # Trim trailing slash from SOURCE_REPOSITORY (if any)           REPO_TRIM="${SOURCE_REPOSITORY%/}"           echo "REPO_TRIM=$REPO_TRIM" >> "$GITHUB_ENV"           # Fallback REF when input is empty           if [ -z "${SOURCE_REF:-}" ]; then             echo "REF_FALLBACK=${GITHUB_REF}" >> "$GITHUB_ENV"           else             echo "REF_FALLBACK=${SOURCE_REF}" >> "$GITHUB_ENV"           fi        - name: Checkout         uses: actions/checkout@v4         with:           repository: ${{ env.REPO_TRIM || env.SOURCE_REPOSITORY }}           ref: ${{ env.REF_FALLBACK || env.SOURCE_REF }}           token: ${{ secrets.XCLI_PAT }}        - name: Bootstrap telemetry (fallback)         shell: bash         run: |           set -euo pipefail           if [ ! -f .codex/telemetry.json ]; then             mkdir -p .codex             echo '{"entries":[]}' > .codex/telemetry.json           fi        - name: Verify telemetry input         # Fails fast with a clear message when .codex/telemetry.json is absent.         # Remediation: run `./scripts/qa.sh` locally to regenerate telemetry before re-running.         run: |           if [ ! -f .codex/telemetry.json ]; then             echo "::error::Missing .codex/telemetry.json; run ./scripts/qa.sh to generate telemetry."             exit 1           fi        - name: Validate telemetry block (non-fatal)         continue-on-error: true         run: python scripts/check_telemetry_block.py        - name: Emit telemetry summary         if: ${{ always() }}         run: |           python - <<'PY'           import json, pathlib           src = json.loads(pathlib.Path('.codex/telemetry.json').read_text())           summary = {'total_entries': len(src.get('entries', []))}           pathlib.Path('telemetry').mkdir(exist_ok=True)           pathlib.Path('telemetry/summary.json').write_text(json.dumps(summary))           PY        - name: Augment summary with human duration (optional)         if: ${{ always() }}         run: |           python scripts/augment_summary_duration.py || true        - name: Upload telemetry.json         uses: actions/upload-artifact@v4         with:           name: codex-telemetry           path: .codex/telemetry.json        - name: Check telemetry summary exists         if: ${{ always() }}         run: |           test -f telemetry/summary.json || {             echo "telemetry/summary.json is missing";             exit 1;           }        - name: Upload telemetry summary         if: ${{ always() }}         uses: actions/upload-artifact@v4         with:           name: telemetry-summary           path: telemetry/summary.json           if-no-files-found: error        - name: Post-run summary (artifact link + entry count)         if: ${{ always() }}         env:           GH_TOKEN: ${{ secrets.XCLI_PAT }}         shell: bash         run: |           set -euo pipefail           PY=$(command -v python3 || command -v python)           "$PY" - <<'PY'           import json, os, sys, urllib.request           repo = os.environ.get('GITHUB_REPOSITORY','')           run_id = os.environ.get('GITHUB_RUN_ID','')           token = os.environ.get('GH_TOKEN','')           summary_path = 'telemetry/summary.json'           total = 'n/a'           try:               with open(summary_path,'r',encoding='utf-8') as f:                   data = json.load(f)                   total = str(data.get('total_entries','n/a'))           except Exception:               pass           ui_url = f"https://github.com/{repo}/actions/runs/{run_id}"           try:               req = urllib.request.Request(                   f"https://api.github.com/repos/{repo}/actions/runs/{run_id}/artifacts",                   headers={                       'accept': 'application/vnd.github+json',                       'authorization': f'Bearer {token}' if token else ''                   }               )               with urllib.request.urlopen(req, timeout=10) as resp:                   artifacts = json.load(resp).get('artifacts', [])               target = next((a for a in artifacts if a.get('name')=='telemetry-summary'), None)               if target and target.get('id'):                   aid = target['id']                   ui_url = f"https://github.com/{repo}/actions/runs/{run_id}/artifacts/{aid}"           except Exception:               pass           # Write to GITHUB_STEP_SUMMARY           summ = os.environ.get('GITHUB_STEP_SUMMARY')           msg = [               '### Stage 1 Telemetry Results',               f"- entries: {total}",               f"- artifact: [telemetry-summary]({ui_url})",           ]           out = '\n'.join(msg) + '\n'           if summ:               with open(summ,'a',encoding='utf-8') as f: f.write(out)           else:               sys.stdout.write(out)           PY        - name: Validate telemetry (schemas)         if: ${{ env.VALIDATE_TELEMETRY_SCHEMA == 'true' || env.VALIDATE_TELEMETRY_SCHEMA == '1' }}         continue-on-error: true         run: |           dotnet run -- telemetry validate \             --summary telemetry/summary.json \             --schema docs/schemas/v1/telemetry.summary.v1.schema.json || true           dotnet run -- telemetry validate \             --events artifacts/qa-telemetry.jsonl \             --schema docs/schemas/v1/telemetry.events.v1.schema.json || true        # Telemetry CLI tests (subset) ΓÇö validates summarize/validate/check behavior       - name: Setup .NET 8         uses: actions/setup-dotnet@v4         with:           dotnet-version: '8.0.x'        - name: Restore .NET solution         run: dotnet restore XCli.sln        - name: Build (Release)         run: dotnet build XCli.sln -c Release --no-restore        - name: Run telemetry tests only         continue-on-error: true         run: dotnet test XCli.sln -c Release --no-build --settings tests/Telemetry.runsettings --logger:"trx;LogFileName=telemetry.trx"        - name: Upload telemetry test results         if: always()         uses: actions/upload-artifact@v4         with:           name: telemetry-tests           path: |             **/TestResults/*/telemetry.trx           if-no-files-found: warn        - name: Token diagnostics (debug)         if: ${{ env.DEBUG_TOKEN_INFO == 'true' || env.DEBUG_TOKEN_INFO == '1' }}         uses: ./.github/actions/token-diagnostics         with:           artifact-name: token-info-stage1           upload-artifact: true        - name: Emit outputs         id: emit         if: ${{ always() }}         run: |           echo "run_id=${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"           echo "summary_path=telemetry/summary.json" >> "$GITHUB_OUTPUT"
