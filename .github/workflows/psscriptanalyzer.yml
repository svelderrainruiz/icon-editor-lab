name: PSScriptAnalyzer

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pssa:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force

      - name: Run PSScriptAnalyzer (advisory)
        shell: pwsh
        run: |
          $paths = @()
          foreach ($candidate in @('src', 'tests', 'tools')) {
            if (Test-Path $candidate) {
              $paths += $candidate
            }
          }
          if ($paths.Count -eq 0) {
            Write-Host 'No PowerShell paths detected; skipping analysis.'
            exit 0
          }
          $settings = Join-Path $PWD '.pssa/PSScriptAnalyzerSettings.psd1'
          $results = @()
          foreach ($path in $paths) {
            try {
              if (Test-Path $settings) {
                Write-Host "Analyzing $path with settings: $settings"
                $results += Invoke-ScriptAnalyzer -Path $path -Settings $settings -Recurse
              }
              else {
                Write-Host "Analyzing $path with default rules."
                $results += Invoke-ScriptAnalyzer -Path $path -Recurse
              }
            }
            catch {
              Write-Warning "PSScriptAnalyzer failed while analyzing $path : $($_.Exception.Message)"
            }
          }
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Warning ("PSScriptAnalyzer reported {0} issue(s); treat as advisory." -f $results.Count)
          }
          else {
            Write-Host 'PSScriptAnalyzer found no issues.'
          }
          exit 0
