name: CI (Windows AllSigned)

on:
  push:
    branches: [ "develop", "main", "master" ]
  pull_request:
    branches: [ "develop", "main", "master" ]
  workflow_dispatch:

jobs:
  windows-signed:
    runs-on: windows-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify PowerShell version
        shell: pwsh
        run: |
          $version = $PSVersionTable.PSVersion
          if ($version -lt [version]'7.4.0') {
            throw "PowerShell 7.4+ required, detected $version"
          }
          Write-Host "Using pwsh $version"

      - name: Import code signing cert (if provided)
        shell: pwsh
        env:
          SIGNING_CERT_B64: ${{ secrets.SIGNING_CERT_B64 }}
          SIGNING_CERT_PASSWORD: ${{ secrets.SIGNING_CERT_PASSWORD }}
        run: |
          if ($env:SIGNING_CERT_B64) {
            $bytes = [Convert]::FromBase64String($env:SIGNING_CERT_B64)
            [IO.File]::WriteAllBytes('code-signing.pfx', $bytes)
            $sec = ConvertTo-SecureString -String $env:SIGNING_CERT_PASSWORD -AsPlainText -Force
            $cert = Import-PfxCertificate -FilePath .\code-signing.pfx -CertStoreLocation Cert:\CurrentUser\My -Password $sec
            Write-Output "Imported code-signing cert: $($cert.Thumbprint)"
          } else {
            Write-Output "No SIGNING_CERT_B64 provided. Will rely on pre-installed certs."
          }

      - name: Sign scripts
        shell: pwsh
        run: |
          $cert = Get-ChildItem Cert:\CurrentUser\My | Where-Object {
            $_.HasPrivateKey -and $_.EnhancedKeyUsageList.FriendlyName -contains 'Code Signing'
          } | Select-Object -First 1
          $skipTimestamp = $false
          if (-not $cert) {
            Write-Host 'No code-signing certificate detected (expected when SIGNING_CERT_B64 is unset); generating an ephemeral certificate for this run.'
            $cert = New-SelfSignedCertificate -Type CodeSigning -Subject 'CN=IconEditorLab Dev Signing' -CertStoreLocation 'Cert:\CurrentUser\My'
            Write-Host ("Ephemeral cert thumbprint: {0}" -f $cert.Thumbprint)
            $tmp = Join-Path $env:TEMP "icon-editor-lab-devsigning.cer"
            Export-Certificate -Cert $cert -FilePath $tmp | Out-Null
            Import-Certificate -FilePath $tmp -CertStoreLocation 'Cert:\CurrentUser\TrustedPublisher' | Out-Null
            $certutilArgs = @('-user','-f','-addstore','Root',$tmp)
            & certutil.exe @certutilArgs | Out-Null
            if ($LASTEXITCODE -ne 0) {
              throw "certutil failed to import the ephemeral signing cert into the Root store (exit code $LASTEXITCODE)."
            }
            Write-Host 'Trusted the dev signing certificate in the CurrentUser Root store via certutil.'
            $skipTimestamp = $true
          }
          ./tools/Sign-Scripts.ps1 -Thumbprint $cert.Thumbprint -SkipTimestamp:$skipTimestamp

      - name: Enforce AllSigned and verify signatures
        shell: pwsh
        run: |
          Set-ExecutionPolicy -ExecutionPolicy AllSigned -Scope Process -Force
          ./tools/Verify-Signatures.ps1

      - name: Validate example config
        shell: pwsh
        run: |
          ./tools/Validate-Config.ps1 -ConfigPath ./configs/examples/vi-diff-heuristics.json

      - name: Run Pester schema tests
        shell: pwsh
        run: |
          Install-Module -Name Pester -Scope CurrentUser -Force -SkipPublisherCheck
          Invoke-Pester ./tests/ConfigSchema.Tests.ps1 -CI -Output Detailed

      - name: Run ScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -SkipPublisherCheck
          $settings = '.pssa/PSScriptAnalyzerSettings.psd1'
          $settingsData = Import-PowerShellDataFile -LiteralPath $settings
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings $settingsData -ReportSummary
          if ($results) {
            $errors = $results | Where-Object { $_.Severity -eq 'Error' }
            if ($errors) {
              $errors | Format-Table -AutoSize
              throw ("PSScriptAnalyzer found {0} blocking error(s)" -f $errors.Count)
            }
            $warnings = $results | Where-Object { $_.Severity -ne 'Error' }
            if ($warnings) {
              Write-Warning ("PSScriptAnalyzer reported {0} warning(s); showing the first 25 entries for awareness." -f $warnings.Count)
              $warnings | Select-Object -First 25 | Format-Table -AutoSize | Out-String | Write-Host
            }
          }
