name: Local CI Handshake

on:
  workflow_dispatch:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

permissions:
  contents: read

jobs:
  ubuntu-handshake:
    runs-on: ubuntu-latest
    outputs:
      stamp: ${{ steps.capture-meta.outputs.stamp }}
      artifact_name: ${{ steps.capture-meta.outputs.artifact_name }}
      manifest_rel: ${{ steps.capture-meta.outputs.manifest_rel }}
      manifest_abs: ${{ steps.capture-meta.outputs.manifest_abs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure PyYAML is available
        run: |
          python3 -m pip install --user --upgrade pip PyYAML

      - name: Run Ubuntu local CI (handshake stages)
        run: |
          bash local-ci/ubuntu/invoke-local-ci.sh \
            --skip 25-docker \
            --skip 28-docs \
            --skip 30-tests \
            --skip 35-coverage

      - name: Capture Ubuntu artifact metadata
        id: capture-meta
        run: |
          POINTER="out/local-ci-ubuntu/latest.json"
          if [[ ! -f "$POINTER" ]]; then
            echo "::error::Pointer file $POINTER not found"
            exit 1
          fi
          python3 - <<'PY' "$POINTER" "$GITHUB_OUTPUT"
  import json, os, sys
  pointer_path, output_path = sys.argv[1:3]
  with open(pointer_path, "r", encoding="utf-8") as handle:
      data = json.load(handle)
  run_root = data.get("run_root") or ""
  timestamp = data.get("timestamp")
  manifest_rel = data.get("manifest_rel") or ""
  manifest_abs = data.get("manifest") or ""
  if not manifest_abs and manifest_rel:
      manifest_abs = os.path.abspath(manifest_rel)
  if not timestamp and run_root:
      timestamp = os.path.basename(run_root.rstrip("/\\"))
  if not timestamp:
      raise SystemExit("Unable to determine Ubuntu run timestamp from pointer.")
  artifact_name = f"ubuntu-local-ci-{timestamp}"
  with open(output_path, "a", encoding="utf-8") as handle:
      handle.write(f"stamp={timestamp}\n")
      handle.write(f"artifact_name={artifact_name}\n")
      if manifest_rel:
          handle.write(f"manifest_rel={manifest_rel}\n")
      if manifest_abs:
          handle.write(f"manifest_abs={manifest_abs}\n")
  print(f"Discovered Ubuntu run stamp {timestamp}")
PY

      - name: Append Ubuntu handshake summary
        if: ${{ always() }}
        run: |
          stamp='${{ steps.capture-meta.outputs.stamp }}'
          manifest='${{ steps.capture-meta.outputs.manifest_rel }}'
          pointer='out/local-ci-ubuntu/latest.json'
          {
            echo "### Ubuntu Handshake";
            echo "";
            echo "- Stamp: ${stamp}";
            echo "- Manifest: ${manifest:-<unknown>}";
            echo "- Pointer: ${pointer}";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Ubuntu handshake artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.capture-meta.outputs.artifact_name }}
          if-no-files-found: error
          path: |
            out/local-ci-ubuntu/${{ steps.capture-meta.outputs.stamp }}
            out/local-ci-ubuntu/latest.json

  windows-consumer:
    needs: ubuntu-handshake
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    env:
      SIGN_ROOT: out
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Ubuntu handshake artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.ubuntu-handshake.outputs.artifact_name }}
          path: ubuntu-handshake

      - name: Restore Ubuntu payload into workspace
        run: |
          $downloadRoot = Join-Path $PWD 'ubuntu-handshake'
          $sourceOut = Join-Path $downloadRoot 'out' 'local-ci-ubuntu'
          if (-not (Test-Path -LiteralPath $sourceOut -PathType Container)) {
            throw "Expected Ubuntu artifacts under $sourceOut"
          }
          $destOut = Join-Path $PWD 'out' 'local-ci-ubuntu'
          if (-not (Test-Path -LiteralPath $destOut)) {
            New-Item -ItemType Directory -Path $destOut -Force | Out-Null
          }
          Copy-Item -Path (Join-Path $sourceOut '*') -Destination $destOut -Recurse -Force
          $stamp = '${{ needs.ubuntu-handshake.outputs.stamp }}'
          if (-not $stamp) {
            throw 'Ubuntu handshake stamp not provided.'
          }
          $manifestPath = Join-Path $destOut $stamp 'ubuntu-run.json'
          if (-not (Test-Path -LiteralPath $manifestPath -PathType Leaf)) {
            throw "Ubuntu manifest not found at $manifestPath"
          }
          "LOCALCI_IMPORT_UBUNTU_RUN=$manifestPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Staged Ubuntu manifest at $manifestPath"

      - name: Run Windows local CI (handshake stages)
        run: |
          ./local-ci/windows/Invoke-LocalCI.ps1 -OnlyStages 10,37

      - name: Collect Windows handshake logs
        if: ${{ always() }}
        run: |
          $runRoot = $null
          $base = Join-Path $PWD 'out' 'local-ci'
          if (Test-Path -LiteralPath $base) {
            $runRoot = Get-ChildItem -Path $base -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if ($runRoot) {
              "LOCALCI_WINDOWS_RUN=$($runRoot.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }

      - name: Append Windows handshake summary
        if: ${{ always() }}
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          if (-not $summaryPath) { return }
          $windowsRun = $env:LOCALCI_WINDOWS_RUN
          $stamp = '${{ needs.ubuntu-handshake.outputs.stamp }}'
          Add-Content -LiteralPath $summaryPath -Value "### Windows Handshake`n"
          Add-Content -LiteralPath $summaryPath -Value "- Ubuntu Stamp: $stamp`n"
          if ($windowsRun) {
            Add-Content -LiteralPath $summaryPath -Value "- Windows Run Root: $windowsRun`n"
          } else {
            Add-Content -LiteralPath $summaryPath -Value "- Windows Run Root: <not produced>`n"
          }

      - name: Upload Windows handshake artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-local-ci-handshake
          path: out/local-ci
          if-no-files-found: warn
