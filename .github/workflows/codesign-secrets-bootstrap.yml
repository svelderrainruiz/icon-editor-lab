name: codesign-secrets-bootstrap

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Provisioning mode: test (generate throwaway cert) or real (import repo secrets)"
        required: true
        default: test
        type: choice
        options:
          - test
          - real

permissions:
  contents: read
  actions: read

jobs:
  provision:
    runs-on: windows-latest
    env:
      GH_PAT_FOR_SECRETS: ${{ secrets.CODESIGN_SECRETS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Provision codesign secrets
        shell: pwsh
        env:
          MODE: ${{ github.event.inputs.mode }}
          REAL_PFX_B64: ${{ secrets.CODESIGN_REAL_PFX_B64 }}
          REAL_PFX_PASSWORD: ${{ secrets.CODESIGN_REAL_PFX_PASSWORD }}
        run: |
          $mode = $env:MODE
          if ([string]::IsNullOrWhiteSpace($mode)) { $mode = 'test' }
          $token = if ($env:GH_PAT_FOR_SECRETS) { $env:GH_PAT_FOR_SECRETS } else { $env:GITHUB_TOKEN }
          if ($mode -ieq 'real') {
            if (-not $env:REAL_PFX_B64 -or -not $env:REAL_PFX_PASSWORD) {
              throw "Real mode requires repository secrets CODESIGN_REAL_PFX_B64 and CODESIGN_REAL_PFX_PASSWORD."
            }
            $pfxPath = Join-Path $env:RUNNER_TEMP 'codesign-real.pfx'
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:REAL_PFX_B64))
            pwsh -NoLogo -NoProfile -File tools/Provision-CodesignSecrets.ps1 `
              -Mode Real `
              -PfxPath $pfxPath `
              -PfxPassword $env:REAL_PFX_PASSWORD `
              -GitHubToken $token
          } else {
            pwsh -NoLogo -NoProfile -File tools/Provision-CodesignSecrets.ps1 `
              -Mode Test `
              -GitHubToken $token
          }
