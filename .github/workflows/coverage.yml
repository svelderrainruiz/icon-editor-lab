name: PR Coverage Gate

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  coverage:
    runs-on: windows-latest
    env:
      COVERAGE_MIN: "75"
      COVERAGE_ENFORCE: "true"
      CRITICAL_PATHS: "src/Core.psm1,tools/Build.ps1"
    steps:
      - uses: actions/checkout@v4

      - name: Install Pester v6
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          if (-not (Get-PackageProvider -Name NuGet -ListAvailable -ErrorAction SilentlyContinue)) {
            Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser -ErrorAction Stop
          }
          $repo = Get-PSRepository -Name PSGallery -ErrorAction SilentlyContinue
          if (-not $repo) {
            Write-Warning 'PSGallery repository missing; registering PSGallery explicitly.'
            Register-PSRepository -Name PSGallery `
              -SourceLocation 'https://www.powershellgallery.com/api/v2' `
              -ScriptSourceLocation 'https://www.powershellgallery.com/api/v2' `
              -PublishLocation 'https://www.powershellgallery.com/api/v2/package/' `
              -InstallationPolicy Trusted
          }
          else {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          }
          $attempt = 0
          $installed = $false
          do {
            try {
              Install-Module Pester -MinimumVersion 6.0.0 -Repository PSGallery -Force -Scope CurrentUser -ErrorAction Stop
              Import-Module  Pester -MinimumVersion 6.0.0 -Force -ErrorAction Stop
              $installed = $true
            }
            catch {
              $attempt++
              Write-Warning "Pester installation attempt $attempt failed: $($_.Exception.Message)"
              if ($attempt -lt 3) {
                Write-Warning 'Retrying install...'
                Start-Sleep -Seconds 5
              }
            }
          } while (-not $installed -and $attempt -lt 3)
          if (-not $installed) {
            Write-Warning 'Falling back to pre-installed Pester module.'
            Import-Module Pester -ErrorAction Stop
          }

      - name: Run Pester (Cobertura + JUnit)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/coverage,artifacts/test-results | Out-Null
          $paths = @()
          foreach ($candidate in @('tests', 'src/tests')) {
            if (Test-Path $candidate) {
              $paths += $candidate
            }
          }
          if ($paths.Count -eq 0) {
            Write-Warning 'No test directories found (tests/src/tests); defaulting to tests'
            $paths = @('tests')
          }
          Write-Host ("Invoking Pester on: {0}" -f ($paths -join ', '))
          $config = New-PesterConfiguration
          $config.Run.Path = $paths
          $config.CodeCoverage.Enabled = $true
          $config.CodeCoverage.OutputFormat = 'Cobertura'
          $config.CodeCoverage.OutputPath  = 'artifacts/coverage/coverage.xml'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputFormat = 'JUnitXml'
          $config.TestResult.OutputPath   = 'artifacts/test-results/results.xml'
          Invoke-Pester -Configuration $config

      - name: Enforce global line coverage (>= ${{ env.COVERAGE_MIN }}%)
        if: env.COVERAGE_ENFORCE == 'true'
        shell: pwsh
        run: |
          if (-not (Test-Path artifacts/coverage/coverage.xml)) {
            throw 'coverage.xml missing'
          }
          [xml]$doc = Get-Content artifacts/coverage/coverage.xml
          $rate = [double]$doc.coverage.GetAttribute('line-rate')
          $pct  = [math]::Round($rate * 100, 2)
          if ($pct -lt [double]$env.COVERAGE_MIN) {
            throw "Coverage $pct% < $env.COVERAGE_MIN%"
          }
          Write-Host "Coverage OK: $pct% >= $env.COVERAGE_MIN%"

      - name: Enforce file floors for critical modules (>= ${{ env.COVERAGE_MIN }}%)
        if: env.COVERAGE_ENFORCE == 'true'
        shell: pwsh
        run: |
          $critical = $env:CRITICAL_PATHS -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
          if (-not (Test-Path artifacts/coverage/coverage.xml)) {
            throw 'coverage.xml missing'
          }
          [xml]$doc = Get-Content artifacts/coverage/coverage.xml
          $classes = $doc.coverage.packages.package.classes.class
          if ($null -eq $classes) {
            Write-Host 'No classes reported; skipping file-floor enforcement.'
            return
          }
          $violations = @()
          foreach ($c in $classes) {
            if ($critical -contains $c.filename) {
              $lines = @($c.lines.line)
              $total = $lines.Count
              $covered = ($lines | Where-Object { [int]$_.hits -gt 0 }).Count
              $pct = if ($total -gt 0) { [math]::Round(($covered / $total) * 100, 2) } else { 100 }
              if ($pct -lt [double]$env:COVERAGE_MIN) { $violations += "$($c.filename)=$pct%" }
            }
          }
          if ($violations.Count -gt 0) {
            throw "File floor breaches: $($violations -join ', ')"
          }
          Write-Host 'File floors OK'

      - name: Upload JUnit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: artifacts/test-results/results.xml

      - name: Upload coverage.xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: artifacts/coverage/coverage.xml
