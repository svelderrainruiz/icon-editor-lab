name: PR Coverage Gate

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  coverage:
    runs-on: windows-latest
    env:
      COVERAGE_THRESHOLD: "75"
      CRITICAL_FILES: '["src/tools/IconEditorPackage.psm1","src/tools/CompareVI.Tools/CompareVI.Tools.psm1"]'
    steps:
      - uses: actions/checkout@v4

      - name: Install Pester v6+
        shell: pwsh
        run: |
          Install-Module Pester -MinimumVersion 6.0.0 -Scope CurrentUser -Force
          Import-Module Pester -MinimumVersion 6.0.0 -ErrorAction Stop

      - name: Prepare artifact directories
        shell: pwsh
        run: |
          @(
            'artifacts/coverage',
            'artifacts/test-results'
          ) | ForEach-Object {
            New-Item -ItemType Directory -Force -Path $_ | Out-Null
          }

      - name: Run Pester with coverage and JUnit output
        shell: pwsh
        run: |
          Invoke-Pester -Configuration @{
            Run         = @{ Path = 'tests' }
            CodeCoverage= @{ Enabled = $true; OutputFormat = 'Cobertura'; OutputPath = 'artifacts/coverage/coverage.xml' }
            TestResult  = @{ Enabled = $true; OutputFormat = 'JUnitXml';  OutputPath = 'artifacts/test-results/results.xml' }
          }

      - name: Enforce coverage thresholds
        shell: pwsh
        run: |
          $coverageFile = 'artifacts/coverage/coverage.xml'
          if (-not (Test-Path $coverageFile)) {
            throw 'Cobertura report artifacts/coverage/coverage.xml not found.'
          }
          $coveragePath = Resolve-Path $coverageFile
          $doc = [System.Xml.XmlDocument]::new()
          $doc.Load($coveragePath)
          $root = $doc.SelectSingleNode('/coverage')
          if (-not $root) {
            throw 'Invalid coverage.xml: missing root node.'
          }
          $lineRateAttribute = $root.Attributes.GetNamedItem('line-rate')
          if (-not $lineRateAttribute) {
            throw 'coverage.xml missing line-rate attribute.'
          }
          $pct = [math]::Round(([double]$lineRateAttribute.Value) * 100, 2)
          $threshold = [double]$env:COVERAGE_THRESHOLD
          if ($pct -lt $threshold) {
            throw "Total line coverage $pct% is below required $threshold%."
          }
          Write-Host "Total coverage $pct% meets >= $threshold% threshold."

      - name: Enforce file floors
        shell: pwsh
        run: |
          $criticalFiles = @()
          if ($env:CRITICAL_FILES) {
            try {
              $criticalFiles = ConvertFrom-Json -InputObject $env:CRITICAL_FILES
            }
            catch {
              Write-Warning "Failed to parse CRITICAL_FILES JSON: $($_.Exception.Message)"
            }
          }
          if (-not $criticalFiles -or $criticalFiles.Count -eq 0) {
            Write-Host 'No critical files configured; skipping file-floor enforcement.'
            return
          }
          $existing = @()
          foreach ($file in $criticalFiles) {
            if (Test-Path $file) {
              $existing += $file
            }
            else {
              Write-Host "Critical file not found locally, skipping: $file"
            }
          }
          if ($existing.Count -eq 0) {
            Write-Host 'No critical files exist locally; skipping file-floor enforcement.'
            return
          }
          $coverageFile = 'artifacts/coverage/coverage.xml'
          if (-not (Test-Path $coverageFile)) {
            throw 'Cobertura report artifacts/coverage/coverage.xml not found.'
          }
          $coveragePath = Resolve-Path $coverageFile
          $doc = [System.Xml.XmlDocument]::new()
          $doc.Load($coveragePath)
          $classNodes = $doc.SelectNodes('/coverage/packages/package/classes/class')
          if (-not $classNodes) {
            throw 'No class entries found in coverage.xml.'
          }
          $threshold = [double]$env:COVERAGE_THRESHOLD
          $violations = @()
          foreach ($target in $existing) {
            $matchingNodes = @($classNodes | Where-Object { $_.filename -ieq $target })
            if ($matchingNodes.Count -eq 0) {
              Write-Warning "No coverage node for $target; treating as 0%."
              $violations += "$target=0"
              continue
            }
            $lineNodes = @()
            foreach ($node in $matchingNodes) {
              $lineNodes += @($node.SelectNodes('lines/line'))
            }
            $total = $lineNodes.Count
            $covered = ($lineNodes | Where-Object { [int]$_.GetAttribute('hits') -gt 0 }).Count
            $pct = if ($total -gt 0) { [math]::Round(($covered / $total) * 100, 2) } else { 100 }
            if ($pct -lt $threshold) {
              $violations += "$target=$pct"
            }
          }
          if ($violations.Count -gt 0) {
            throw "Per-file coverage breaches detected (<$threshold%): $($violations -join ', ')"
          }
          Write-Host 'All critical files meet per-file coverage threshold.'

      - name: Upload JUnit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: artifacts/test-results/results.xml
          if-no-files-found: warn

      - name: Upload coverage.xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: artifacts/coverage/coverage.xml
          if-no-files-found: warn
