#Requires -Version 7.0
[CmdletBinding()]
param(
  [string]$Destination,
  [switch]$Zip,
  [switch]$IncludeWorkflow,
  [string]$TargetRepoRoot,
  [switch]$GenerateIssueTemplate
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

function Resolve-RepoRoot {
  return (Get-Item (Join-Path $PSScriptRoot '..')).FullName
}

$repoRoot = Resolve-RepoRoot
$timestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
if (-not $Destination) {
  $Destination = Join-Path $repoRoot "out/semver-bundle/$timestamp"
}

$bundleRoot = (New-Item -ItemType Directory -Force -Path $Destination).FullName

$filesToCopy = @(
  'src/tools/priority/validate-semver.mjs',
  'docs/semver-guard-kit.md',
  'docs/semver-node-evidence.md'
)
if ($IncludeWorkflow) {
  $workflowRelativePath = '.github/workflows/semver-guard.yml'
  $checklistRelativePath = 'IMPORT-CHECKLIST.md'
} else {
  $workflowRelativePath = $null
  $checklistRelativePath = $null
}

$manifestEntries = New-Object System.Collections.Generic.List[object]

function Add-ManifestEntry {
  param(
    [Parameter(Mandatory)][string]$SourcePath,
    [Parameter(Mandatory)][string]$RelativePath
  )

  if (-not (Test-Path -LiteralPath $SourcePath -PathType Leaf)) {
    return
  }
  $hash = Get-FileHash -Path $SourcePath -Algorithm SHA256
  $size = (Get-Item -LiteralPath $SourcePath).Length
  $manifestEntries.Add([ordered]@{
      relativePath = $RelativePath
      sha256       = $hash.Hash
      sizeBytes    = $size
    }) | Out-Null
}

function Invoke-Git {
  param([string[]]$Arguments)
  try {
    $result = & git -C $repoRoot @Arguments 2>$null
    if ($LASTEXITCODE -ne 0) { return $null }
    return $result.Trim()
  } catch { return $null }
}

function Get-GitMetadata {
  return [pscustomobject]@{
    commit = Invoke-Git -Arguments @('rev-parse', 'HEAD')
    branch = Invoke-Git -Arguments @('rev-parse', '--abbrev-ref', 'HEAD')
  }
}

$gitInfo = Get-GitMetadata

foreach ($relativePath in $filesToCopy) {
  $sourcePath = Join-Path $repoRoot $relativePath
  if (-not (Test-Path -LiteralPath $sourcePath -PathType Leaf)) {
    throw "Source file not found: $relativePath"
  }
  $targetPath = Join-Path $bundleRoot $relativePath
  $targetDir = Split-Path -Parent $targetPath
  if (-not (Test-Path -LiteralPath $targetDir -PathType Container)) {
    New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
  }
  Copy-Item -LiteralPath $sourcePath -Destination $targetPath -Force
  Add-ManifestEntry -SourcePath $sourcePath -RelativePath $relativePath
}

if ($IncludeWorkflow) {
  $workflowPath = Join-Path $bundleRoot $workflowRelativePath
  $workflowDir = Split-Path -Parent $workflowPath
  if (-not (Test-Path -LiteralPath $workflowDir -PathType Container)) {
    New-Item -ItemType Directory -Force -Path $workflowDir | Out-Null
  }
  $workflowContent = @"
name: SemVer Guard

on:
  workflow_dispatch:
  pull_request:

jobs:
  semver:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm install
      - run: npm run semver:check
"@
  $workflowContent | Out-File -FilePath $workflowPath -Encoding UTF8
  Add-ManifestEntry -SourcePath $workflowPath -RelativePath $workflowRelativePath

  $checklistPath = Join-Path $bundleRoot $checklistRelativePath
  $checklist = @"
# SemVer Guard Import Checklist

1. Copy `src/tools/priority/validate-semver.mjs` and the docs in `docs/` into your repo.
2. Add `"semver:check": "node ./src/tools/priority/validate-semver.mjs"` to `package.json` and pin Node to `>=20.11.0`.
3. Run `npm install` then `npm run semver:check` locally to confirm the guard works.
4. Drop `.github/workflows/semver-guard.yml` into your repo (customize triggers as needed).
5. Verify the bundle integrity via `bundle.json` (SHA256 hashes).
6. Comment on the tracking issue with the steps you completed.
"@
  $checklist | Out-File -FilePath $checklistPath -Encoding UTF8
  Add-ManifestEntry -SourcePath $checklistPath -RelativePath $checklistRelativePath
}

$readmePath = Join-Path $bundleRoot 'README.md'
$readme = @"
# SemVer Bundle

This bundle was generated by `tools/Export-SemverBundle.ps1` on $(Get-Date -Format o).

Included artifacts:

1. `src/tools/priority/validate-semver.mjs` — Node script that validates the repository version field.
2. `docs/semver-guard-kit.md` — step-by-step instructions for adopting the SemVer guard + Node pin in other repos.
3. `docs/semver-node-evidence.md` — evidence log showing the guard in action inside icon-editor-lab.

## Quick start

```powershell
npm install
npm run semver:check
```

Make sure the target repository pins Node 20 (`"engines": { "node": ">=20.11.0" }`) and uses `actions/setup-node@v4` in CI before running the script.
"@
$readme | Out-File -FilePath $readmePath -Encoding UTF8
Add-ManifestEntry -SourcePath $readmePath -RelativePath 'README.md'

$manifestPath = Join-Path $bundleRoot 'bundle.json'
$manifest = [ordered]@{
  schema      = 'icon-editor/semver-bundle@v1'
  generatedAt = (Get-Date).ToString('o')
  repo        = [ordered]@{
    root   = $repoRoot
    commit = $gitInfo.commit
    branch = $gitInfo.branch
  }
  files       = $manifestEntries
}
$manifest | ConvertTo-Json -Depth 4 | Out-File -FilePath $manifestPath -Encoding UTF8

$zipPath = $null
if ($Zip) {
  $zipPath = "$bundleRoot.zip"
  if (Test-Path -LiteralPath $zipPath) {
    Remove-Item -LiteralPath $zipPath -Force
  }
  Compress-Archive -Path (Join-Path $bundleRoot '*') -DestinationPath $zipPath
}

$copiedTargets = @()
if ($TargetRepoRoot) {
  foreach ($relativePath in $filesToCopy) {
    $targetPath = Join-Path $TargetRepoRoot $relativePath
    $targetDir = Split-Path -Parent $targetPath
    if (-not (Test-Path -LiteralPath $targetDir -PathType Container)) {
      New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
    }
    Copy-Item -LiteralPath (Join-Path $bundleRoot $relativePath) -Destination $targetPath -Force
    $copiedTargets += $targetPath
  }
  if ($IncludeWorkflow) {
    foreach ($extra in @($workflowRelativePath, $checklistRelativePath)) {
      if (-not $extra) { continue }
      $targetPath = Join-Path $TargetRepoRoot $extra
      $targetDir = Split-Path -Parent $targetPath
      if (-not (Test-Path -LiteralPath $targetDir -PathType Container)) {
        New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
      }
      Copy-Item -LiteralPath (Join-Path $bundleRoot $extra) -Destination $targetPath -Force
      $copiedTargets += $targetPath
    }
  }
  if ($GenerateIssueTemplate -and (Test-Path -LiteralPath $issueTemplatePath -PathType Leaf)) {
    $targetPath = Join-Path $TargetRepoRoot 'ISSUE-TEMPLATE.md'
    Copy-Item -LiteralPath $issueTemplatePath -Destination $targetPath -Force
    $copiedTargets += $targetPath
  }
}

[pscustomobject]@{
  BundleRoot = $bundleRoot
  ZipPath = $zipPath
  TargetRepoRoot = $TargetRepoRoot
  CopiedTargets = $copiedTargets
}
$issueTemplatePath = Join-Path $bundleRoot 'ISSUE-TEMPLATE.md'
if ($GenerateIssueTemplate) {
  $templateSource = Join-Path $repoRoot 'tools/templates/Semver-Issue.md'
  if (-not (Test-Path -LiteralPath $templateSource -PathType Leaf)) {
    throw "Issue template not found at $templateSource"
  }
  Copy-Item -LiteralPath $templateSource -Destination $issueTemplatePath -Force
  Add-ManifestEntry -SourcePath $issueTemplatePath -RelativePath 'ISSUE-TEMPLATE.md'
}
