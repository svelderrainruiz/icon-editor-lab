# Update-SessionIndexBranchProtection.ps1

**Path:** `tools/Update-SessionIndexBranchProtection.ps1`

## Synopsis
Augment a `session-index.json` with branch-protection metadata (expected contexts vs produced contexts) and append a summary to the GitHub step report.

## Description
- Reads the required status contexts per branch from `tools/policy/branch-required-checks.json`.
- Normalizes the current branch name (supports refs/heads/* and PR refs) and selects the policy entry.
- Computes the policy file digest, compares `ProducedContexts` (or defaults) with the expected contexts, and writes a `branchProtection` block into `session-index.json` containing:
  - `policy`: digest, branch, expected contexts.
  - `produced`: contexts emitted in this run.
  - `status`: `ok` / `warn` / `fail` (strict mode escalates mismatches to fail).
  - Optional `actual` data when `-ActualContexts` is supplied (e.g., contexts retrieved from GitHub).  
- Updates `session-index.json` in-place and echoes a human-readable summary to `$GITHUB_STEP_SUMMARY`.

### Parameters
| Name | Type | Default | Notes |
| --- | --- | --- | --- |
| `ResultsDir` | string | `tests/results` | Directory containing `session-index.json`. |
| `PolicyPath` | string | `tools/policy/branch-required-checks.json` | JSON describing required contexts. |
| `ProducedContexts` | string[] | Defaults to expected contexts | Explicit list of contexts generated by this workflow. |
| `Branch` | string | `$env:GITHUB_REF_NAME` | Branch to evaluate (handles refs and PR merges). |
| `Strict` | switch | Off | Fail the session when contexts mismatch instead of issuing a warning. |
| `ActualContexts` | string[] | — | Contexts retrieved from branch protection checks (optional). |
| `ActualStatus` | string (`available`,`unavailable`,`error`) | Based on `ActualContexts` | Sets `actual.status` in the session index. |
| `AdditionalNotes` | string[] | — | Notes appended to the session index summary. |

## Exit Codes
- `0` — Metadata injected successfully.
- `!=0` — `session-index.json` or policy file missing/invalid.

## Related
- `tools/Ensure-SessionIndex.ps1`
- `tools/Write-SessionIndexSummary.ps1`
- `tools/policy/branch-required-checks.json`
