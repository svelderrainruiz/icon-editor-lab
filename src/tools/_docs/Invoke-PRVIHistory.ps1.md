# Invoke-PRVIHistory.ps1

**Path:** `tools/Invoke-PRVIHistory.ps1`

## Synopsis
Expands a `vi-diff-manifest@v1` document into individual VI history jobs, runs `tools/Compare-VIHistory.ps1` for each, and emits a `pr-vi-history-summary@v1` telemetry file.

## Description
- Deduplicates VI paths from the manifest generated by `tools/Get-PRVIDiffManifest.ps1`, verifies both base/head paths exist (unless they’re intentionally missing), and skips entries that cannot be materialized.
- Invokes Compare-VIHistory with optional `-MaxPairs`, `-Mode`, `-StartRef`, `-EndRef`, and `-IncludeMergeParents` arguments, writing per-target folders under `ResultsRoot` containing Markdown/HTML reports plus the raw CLI logs.
- Aggregates execution statistics (processed comparisons, diff counts, missing files) into `<ResultsRoot>/vi-history-summary.json`, writes GitHub Action outputs when available, and returns the summary object to the caller.

### Parameters
| Name | Type | Default | Notes |
| --- | --- | --- | --- |
| `ManifestPath` | string (required) | - | Path to the `vi-diff-manifest@v1` JSON file. |
| `ResultsRoot` | string | `tests/results/pr-vi-history` | Parent folder for per-VI results. |
| `MaxPairs` | int? | - | Limit on commit pairs per VI; 0 or null means “all”. |
| `Mode` | string[] | - | Direct pass-through to Compare-VIHistory (e.g., `default`, `attributes`). |
| `SkipRenderReport` | switch | Off | Prevent Compare-VIHistory from producing Markdown/HTML reports. |
| `DryRun` | switch | Off | Show the execution plan without invoking Compare-VIHistory. |
| `CompareInvoker` | scriptblock | - | Test hook that overrides the Compare-VIHistory call. |
| `SummaryPath` | string | `<ResultsRoot>/vi-history-summary.json` | Where the aggregated telemetry is written. |
| `StartRef` / `EndRef` | string | - | Override refs passed to Compare-VIHistory. |
| `IncludeMergeParents` | switch | Off | Forwarded to Compare-VIHistory to include merge parents. |

## Outputs
- `<ResultsRoot>/<vi-name>/history-report.{md,html}` plus analyzer stats/JSON from Compare-VIHistory.
- Summary JSON (`pr-vi-history-summary@v1`) containing totals, target metadata, and report locations; echoed to `$GITHUB_OUTPUT` when available.

## Exit Codes
- `0` – All targets that could be staged were processed; inspect summary for diff counts.
- `!=0` – One or more targets failed (exceptions bubble up after writing partial summary data).

## Related
- `tools/Get-PRVIDiffManifest.ps1`
- `tools/Compare-VIHistory.ps1`
- `tools/Invoke-PRVIStaging.ps1`
